server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # ===== 安全响应头 =====

    # 防止浏览器 MIME 类型嗅探，避免将非脚本资源误当作脚本执行
    add_header X-Content-Type-Options "nosniff" always;

    # 防止页面被嵌入 iframe，抵御点击劫持攻击
    add_header X-Frame-Options "DENY" always;

    # 控制 Referrer 信息泄露：同源完整发送，跨域仅发送 origin
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # 内容安全策略 (CSP) - 最核心的安全防护头
    #   default-src 'self'          : 默认只允许加载同源资源
    #   script-src 'self'           : 脚本只允许同源（含 config.js），阻止内联脚本和 eval
    #   style-src 'self' 'unsafe-inline' : 样式允许同源和内联（React/UI 库需要动态样式注入）
    #   img-src 'self' data: blob:  : 图片允许同源、data URI（base64 图片）和 blob URL
    #   media-src 'self' blob:      : 媒体允许同源和 blob URL（Live API 音频播放）
    #   connect-src 'self' https: wss: : 允许同源及所有 HTTPS/WSS 连接（用户可配置自定义 API 端点）
    #   font-src 'self'             : 字体只允许同源
    #   object-src 'none'           : 禁止 Flash/Java 等插件
    #   base-uri 'self'             : 限制 <base> 标签为同源
    #   form-action 'self'          : 限制表单提交目标为同源
    #   frame-ancestors 'none'      : 禁止任何页面嵌入本站（配合 X-Frame-Options）
    #   worker-src 'self' blob:     : Web Worker 允许同源和 blob URL
    add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; media-src 'self' blob:; connect-src 'self' https: wss:; font-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; worker-src 'self' blob:;" always;

    # 权限策略 - 精细控制浏览器功能访问
    #   camera=()           : 禁止摄像头
    #   microphone=(self)   : 允许同源使用麦克风（Live API 语音功能需要）
    #   geolocation=()      : 禁止地理定位
    #   payment=()          : 禁止支付 API
    #   usb=()              : 禁止 USB 设备访问
    #   display-capture=()  : 禁止屏幕捕获
    add_header Permissions-Policy "camera=(), microphone=(self), geolocation=(), payment=(), usb=(), display-capture=()" always;

    # 跨域隔离策略 - 防止跨域窗口引用
    add_header Cross-Origin-Opener-Policy "same-origin" always;

    # ===== Gzip 压缩 =====
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml application/javascript;

    # 处理 SPA 路由 - 所有路由都返回 index.html
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 静态资源缓存
    # 注意：Nginx 中 location 块内若存在 add_header 指令，将不继承 server 块的 add_header
    # 因此需要在此处重新声明关键安全头
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";

        # 重复声明安全头（Nginx add_header 继承规则要求）
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
    }
}
